
# ðŸ“„ Ð¢ÐµÑ…Ð½Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ Ð·Ð°Ð´Ð°Ð½Ð¸Ðµ (Ð¢Ð—): Visitor Tracking & Anti-Spam Scoring (Laravel)

## ðŸ“Œ Ð¦ÐµÐ»ÑŒ
Ð¡Ð¾Ð±Ñ€Ð°Ñ‚ÑŒ Ð¸ Ð¾Ð±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°Ñ‚ÑŒ Ð¾Ñ‚Ð¿ÐµÑ‡Ð°Ñ‚ÐºÐ¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹ (fingerprint) Ð´Ð»Ñ Ð·Ð°Ñ‰Ð¸Ñ‚Ñ‹ Ð¾Ñ‚ ÑÐ¿Ð°Ð¼Ð°, ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ð¿Ð¾Ð²ÐµÐ´ÐµÐ½Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»Ñ Ð¸ Ð¿Ñ€Ð¸Ð²ÑÐ·ÐºÐ¸ Ðº Ð·Ð°ÑÐ²ÐºÐ°Ð¼. Ð Ð°ÑÑÑ‡Ð¸Ñ‚Ñ‹Ð²Ð°Ñ‚ÑŒ `spam_score` Ð¿Ñ€Ð¸ ÐºÐ°Ð¶Ð´Ð¾Ð¼ Ð¾Ð±Ñ€Ð°Ñ‰ÐµÐ½Ð¸Ð¸.

---

## ðŸ”§ Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°

### ðŸ“ ÐœÐ¾Ð´ÐµÐ»Ð¸
- `VisitorTrack` â€” Ð¾Ñ‚Ð¿ÐµÑ‡Ð°Ñ‚Ð¾Ðº Ð¸ Ð¿Ð¾Ð²ÐµÐ´ÐµÐ½Ð¸Ðµ Ð±Ñ€Ð°ÑƒÐ·ÐµÑ€Ð°
- `Order` â€” Ð·Ð°ÑÐ²ÐºÐ° (ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð°Ñ)
- `SuspiciousOrder` *(Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾)* â€” Ð·Ð°ÑÐ²ÐºÐ¸, Ð¾Ñ‚Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ Ð¿Ð¾ ÑÐ¿Ð°Ð¼Ñƒ

### ðŸ“ Ð¡ÐµÑ€Ð²Ð¸ÑÐ½Ñ‹Ðµ ÐºÐ»Ð°ÑÑÑ‹
- `SpamScoreService` â€” Ñ€Ð°ÑÑ‡Ñ‘Ñ‚ `spam_score`
- `VisitorTrackService` â€” ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ Ð¸ ÑÐ²ÑÐ·Ñ‹Ð²Ð°Ð½Ð¸Ðµ Ð¾Ñ‚Ð¿ÐµÑ‡Ð°Ñ‚ÐºÐ¾Ð²

---

## ðŸ“¦ 1. ÐœÐ¾Ð´ÐµÐ»ÑŒ VisitorTrack

```php
class VisitorTrack extends Model {
    protected $fillable = [...];

    public function orders() {
        return $this->hasMany(Order::class);
    }
}
```

---

## ðŸ“¦ 2. ÐœÐ¾Ð´ÐµÐ»ÑŒ Order

### ÐœÐ¸Ð³Ñ€Ð°Ñ†Ð¸Ñ:

```php
$table->foreignId('visitor_track_id')->nullable()->constrained('visitor_tracks');
$table->float('spam_score')->default(0);
```

### ÐœÐ¾Ð´ÐµÐ»ÑŒ:

```php
public function visitorTrack() {
    return $this->belongsTo(VisitorTrack::class);
}
```

---

## âš™ï¸ 3. VisitorTrackService

```php
class VisitorTrackService {
  public static function storeOrUpdate(array $data, string $ip): VisitorTrack {
    $track = VisitorTrack::firstOrCreate([...]);
    $track->fill($data);
    $track->ip = $ip;
    $track->save();
    return $track;
  }
}
```

---

## âš™ï¸ 4. SpamScoreService

```php
public static function calculate(VisitorTrack $track): float
// Ð°Ð½Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ local_id, IP, user_agent, webdriver Ð¸ Ð´Ñ€ÑƒÐ³Ð¸Ðµ Ð¿Ñ€Ð¸Ð·Ð½Ð°ÐºÐ¸
```

---

## ðŸ”Œ 5. ÐšÐ¾Ð½Ñ‚Ñ€Ð¾Ð»Ð»ÐµÑ€ VisitorTrackController

```php
public function store(Request $request) {
    $data = $request->validate([...]);
    $track = VisitorTrackService::storeOrUpdate($data, $request->ip());
    return response()->json(['status' => 'ok', 'id' => $track->id]);
}
```

---

## ðŸ’¡ ÐŸÑ€Ð¸Ð¼ÐµÑ€ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ Ð² Ð·Ð°ÑÐ²ÐºÐµ

```php
$track = VisitorTrack::where('local_id', $request->input('local_id'))->latest()->first();

$order = Order::create([
  'visitor_track_id' => $track?->id,
  'spam_score' => SpamScoreService::calculate($track),
]);
```

---
