
# 📄 Техническое задание (ТЗ): Visitor Tracking & Anti-Spam Scoring (Laravel)

## 📌 Цель
Собрать и обрабатывать отпечатки пользователей (fingerprint) для защиты от спама, создания поведенческого профиля и привязки к заявкам. Рассчитывать `spam_score` при каждом обращении.

---

## 🔧 Структура проекта

### 📁 Модели
- `VisitorTrack` — отпечаток и поведение браузера
- `Order` — заявка (существующая)
- `SuspiciousOrder` *(опционально)* — заявки, отфильтрованные по спаму

### 📁 Сервисные классы
- `SpamScoreService` — расчёт `spam_score`
- `VisitorTrackService` — сохранение и связывание отпечатков

---

## 📦 1. Модель VisitorTrack

```php
class VisitorTrack extends Model {
    protected $fillable = [...];

    public function orders() {
        return $this->hasMany(Order::class);
    }
}
```

---

## 📦 2. Модель Order

### Миграция:

```php
$table->foreignId('visitor_track_id')->nullable()->constrained('visitor_tracks');
$table->float('spam_score')->default(0);
```

### Модель:

```php
public function visitorTrack() {
    return $this->belongsTo(VisitorTrack::class);
}
```

---

## ⚙️ 3. VisitorTrackService

```php
class VisitorTrackService {
  public static function storeOrUpdate(array $data, string $ip): VisitorTrack {
    $track = VisitorTrack::firstOrCreate([...]);
    $track->fill($data);
    $track->ip = $ip;
    $track->save();
    return $track;
  }
}
```

---

## ⚙️ 4. SpamScoreService

```php
public static function calculate(VisitorTrack $track): float
// анализировать local_id, IP, user_agent, webdriver и другие признаки
```

---

## 🔌 5. Контроллер VisitorTrackController

```php
public function store(Request $request) {
    $data = $request->validate([...]);
    $track = VisitorTrackService::storeOrUpdate($data, $request->ip());
    return response()->json(['status' => 'ok', 'id' => $track->id]);
}
```

---

## 💡 Пример использования в заявке

```php
$track = VisitorTrack::where('local_id', $request->input('local_id'))->latest()->first();

$order = Order::create([
  'visitor_track_id' => $track?->id,
  'spam_score' => SpamScoreService::calculate($track),
]);
```

---
